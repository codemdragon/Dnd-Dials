<script>
(function(){
  const MORSE = {
    A: ".-",   B: "-...", C: "-.-.", D: "-..",  E: ".",
    F: "..-.", G: "--.",  H: "....", I: "..",   J: ".---",
    K: "-.-",  L: ".-..", M: "--",   N: "-.",  O: "---",
    P: ".--.", Q: "--.-", R: ".-.",  S: "...",  T: "-",
    U: "..-",  V: "...-", W: ".--",  X: "-..-", Y: "-.--",
    Z: "--.."
  };
  const LETTERS = Object.keys(MORSE);

  function caesarEncode(text, shift = 5) {
    return text.replace(/[A-Za-z]/g, char => {
      const isUpperCase = char === char.toUpperCase();
      const base = isUpperCase ? 'A'.charCodeAt(0) : 'a'.charCodeAt(0);
      const code = char.charCodeAt(0);
      return String.fromCharCode(((code - base + shift) % 26) + base);
    });
  }

  function caesarDecode(text, shift = 5) {
    return text.replace(/[A-Za-z]/g, char => {
      const isUpperCase = char === char.toUpperCase();
      const base = isUpperCase ? 'A'.charCodeAt(0) : 'a'.charCodeAt(0);
      const code = char.charCodeAt(0);
      return String.fromCharCode(((code - base - shift + 26) % 26) + base);
    });
  }

  const params = new URLSearchParams(location.search);
  let encodedWord = params.get('word') || 'KNWJ';
  let encodedMsg = params.get('msg') || 'Tujsy%25bs%25iwj%25hwp%25fsi%25ymnj%25qnsijx%25tujqf%3F';

  let TARGET = caesarDecode(encodedWord);
  let WINMSG = decodeURIComponent(caesarDecode(encodedMsg));
  let TARGET_MORSE = "";

  const lockEl = document.getElementById('lock');
  const gate = document.getElementById('gate');
  const wordEl = document.getElementById('currentWord');
  const overlay = document.getElementById('overlay');
  const msg = document.getElementById('msg');
  const modalTitle = document.getElementById('modalTitle');
  const toast = document.getElementById('toast');
  const unlockBtn = document.getElementById('btnUnlock');
  const closeModalBtn = document.getElementById('closeModal');

  const dials = [];
  let isSolved = false;

  function makeDial(i){
    const dial = document.createElement('div');
    dial.className = 'dial';

    const windowEl = document.createElement('div');
    windowEl.className = 'window';

    const strip = document.createElement('div');
    strip.className = 'strip';

    LETTERS.forEach((L, idx)=>{
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.setAttribute('data-i', idx);

      // âœ… only show Morse, no letters
      const morse = document.createElement('div');
      morse.className='morse';
      morse.textContent = MORSE[L];

      cell.appendChild(morse);
      strip.appendChild(cell);
    });

    windowEl.appendChild(strip);
    dial.appendChild(windowEl);

    const ctrls = document.createElement('div');
    ctrls.className = 'controls';
    const up = document.createElement('button'); up.className='arrow'; up.innerHTML = 'â–²';
    const down = document.createElement('button'); down.className='arrow'; down.innerHTML = 'â–¼';
    ctrls.appendChild(up); ctrls.appendChild(down);
    dial.appendChild(ctrls);

    const state = { root:dial, strip, index:0 };

    function setIndex(newIndex){
      const max = LETTERS.length;
      state.index = (newIndex % max + max) % max;

      const cellH = strip.querySelector('.cell').offsetHeight + 8;
      const offset = (windowEl.clientHeight/2) - (cellH/2);
      strip.style.transform = `translateY(${offset - state.index*cellH}px)`;

      [...strip.children].forEach((c, idx)=> c.classList.toggle('active', idx===state.index));
      onChange();
    }

    up.addEventListener('click', ()=> setIndex(state.index-1));
    down.addEventListener('click', ()=> setIndex(state.index+1));

    setIndex(Math.floor(Math.random()*LETTERS.length));

    return { ...state, setIndex };
  }

  function rebuild(){
    lockEl.innerHTML=''; dials.length = 0;

    // ðŸ”§ Target Morse sequence
    TARGET_MORSE = TARGET.split('').map(L => MORSE[L]).join(' ');

    for(let i=0;i<TARGET.length;i++){
      const d = makeDial(i); 
      dials.push(d); 
      lockEl.appendChild(d.root);
    }
    updateWord();
    checkSolved();
  }

  // Current Morse sequence
  function currentLetters(){
    return dials.map(d => {
      const L = LETTERS[d.index];
      return MORSE[L];
    }).join(' ');
  }

  function updateWord(){
    const letters = currentLetters();
    wordEl.textContent = letters || 'â€¢';
  }

  function checkSolved(){
    const letters = currentLetters();
    isSolved = letters === TARGET_MORSE;
    gate.classList.toggle('unlocked', isSolved);
    gate.classList.toggle('locked', !isSolved);
    gate.querySelector('.status').textContent = isSolved ? 'UNLOCKED' : 'LOCKED';
    unlockBtn.disabled = false; 
    return isSolved;
  }

  function onChange(){
    updateWord();
    checkSolved();
  }

  function shuffle(){ dials.forEach(d=> d.setIndex(Math.floor(Math.random()*LETTERS.length))); }

  function share(){
    const encodedWord = caesarEncode(TARGET);
    const encodedMsg = encodeURIComponent(caesarEncode(WINMSG));
    
    const url = new URL(location.origin + location.pathname);
    url.searchParams.set('word', encodedWord);
    url.searchParams.set('msg', encodedMsg);
    navigator.clipboard.writeText(url.toString()).then(()=>{
      toast.textContent = 'Shareable puzzle link copied!';
      toast.classList.add('show');
      setTimeout(()=> toast.classList.remove('show'), 1800);
    });
  }

  function unlock() {
    const letters = currentLetters();
    console.log('Unlock clicked â€”', letters, 'TARGET:', TARGET_MORSE);

    if (letters === TARGET_MORSE) {
      modalTitle.textContent = "Box Unlocked!";
      msg.innerHTML = WINMSG + `<br><br>Word: ${TARGET}`;
      overlay.classList.add('show');
    } else {
      modalTitle.textContent = "Incorrect Combination";
      msg.textContent = `"${letters}" is not the correct sequence. Keep trying!`;
      overlay.classList.add('show');
    }
  }

  document.getElementById('btnShuffle').addEventListener('click', shuffle);
  document.getElementById('btnShare').addEventListener('click', share);
  unlockBtn.addEventListener('click', unlock);
  closeModalBtn.addEventListener('click', () => {
    overlay.classList.remove('show');
  });

  rebuild();
  console.log("Target word:", TARGET, "â†’ Morse:", TARGET_MORSE);
})();
</script>
