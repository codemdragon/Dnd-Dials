<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Morse Dial Puzzle Box</title>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #121925;
      --accent: #6ee7ff;
      --accent2: #a78bfa;
      --good: #34d399;
      --warn: #f59e0b;
      --bad: #ef4444;
      --text: #e6f1ff;
      --muted: #97a3b6;
      --ring: 0 0 0 2px rgba(110, 231, 255, .15), 0 0 32px rgba(110, 231, 255, .08) inset;
    }
    * {
      box-sizing: border-box
    }
    html,
    body {
      height: 100%
    }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 700px at 70% -10%, #162032 0%, var(--bg) 60%);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .app {
      width: min(1100px, 100%);
    }

    header {
      display: flex;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px
    }
    .title {
      font-size: clamp(20px, 3vw, 28px);
      letter-spacing: .5px;
      font-weight: 700
    }
    .subtitle {
      color: var(--muted);
      font-size: 14px
    }

    .wrap {
      background: linear-gradient(180deg, rgba(255, 255, 255, .04), rgba(255, 255, 255, .02));
      border: 1px solid rgba(255, 255, 255, .06);
      border-radius: 20px;
      padding: 18px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, .35);
    }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    button,
    .btn {
      background: linear-gradient(180deg, #1a2436, #12192a);
      color: var(--text);
      border: 1px solid rgba(255, 255, 255, .08);
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      transition: transform .05s ease, box-shadow .2s ease, border-color .2s ease;
      box-shadow: var(--ring);
      font-weight: 600;
      letter-spacing: .3px;
      user-select: none;
    }
    button:hover {
      border-color: rgba(110, 231, 255, .35)
    }
    button:active {
      transform: translateY(1px)
    }
    .ghost {
      background: transparent;
      border-color: rgba(255, 255, 255, .12)
    }

    .grid {
      display: grid;
      gap: 18px;
    }
    @media (min-width:900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .lock {
      display: flex;
      gap: 16px;
      justify-content: center;
      align-items: stretch;
      padding: 18px;
    }
    .dial {
      width: min(180px, 22vw);
      background: linear-gradient(180deg, #0f1624, #0c1220);
      border: 1px solid rgba(255, 255, 255, .08);
      border-radius: 18px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 30px rgba(0, 0, 0, .35);
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: space-between;
      outline: none;
    }
    .dial:focus-visible {
      box-shadow: 0 0 0 2px var(--accent);
    }

    .dial .head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, .06);
    }
    .dial .label {
      font-size: 12px;
      color: var(--muted);
      letter-spacing: .4px
    }
    .dial .index {
      font-variant-numeric: tabular-nums;
      font-weight: 700;
      color: #c8d7ff
    }

    .window {
      position: relative;
      height: 140px;
      margin: 10px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, .06);
      background: radial-gradient(240px 120px at 50% 10%, rgba(167, 139, 250, .15), transparent 60%);
      overflow: hidden;
    }
    .strip {
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      transition: transform .25s cubic-bezier(.2, .7, .2, 1);
      padding: 8px 0;
    }
    .cell {
      padding: 6px 10px;
      min-height: 28px;
      display: flex;
      align-items: center;
      gap: 8px;
      opacity: .45;
      filter: saturate(.7);
    }
    .cell .morse {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      letter-spacing: 2px;
    }
    .cell .letter {
      font-size: 12px;
      color: var(--muted);
      opacity: .0;
      transition: opacity .2s;
    }

    .cell.active {
      opacity: 1;
      filter: none;
      transform: scale(1.03);
    }
    .cell.active .letter.revealed {
      opacity: .9;
    }

    .dial .controls {
      padding: 10px;
      border-top: 1px solid rgba(255, 255, 255, .06);
      display: flex;
      gap: 8px;
      justify-content: space-between
    }
    .arrow {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .gate {
      margin-top: 16px;
      text-align: center;
    }
    .gate .status {
      font-weight: 700;
      letter-spacing: .4px;
    }
    .gate.locked .status {
      color: var(--warn);
    }
    .gate.unlocked .status {
      color: var(--good);
      text-shadow: 0 0 18px rgba(52, 211, 153, .35);
    }
    .gate .word {
      margin-top: 8px;
      font-size: 22px;
      letter-spacing: 6px;
    }

    .hint {
      color: var(--muted);
      font-size: 13px;
      margin-top: 10px
    }
    .divider {
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, .12), transparent);
      margin: 14px 0
    }

    .toast {
      position: fixed;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      background: #0f1624;
      border: 1px solid rgba(255, 255, 255, .1);
      padding: 10px 14px;
      border-radius: 10px;
      color: var(--text);
      display: none
    }
    .toast.show {
      display: block
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(900px 600px at 50% -10%, rgba(52, 211, 153, .12), transparent 60%), rgba(0, 0, 0, .75);
      display: none;
      place-items: center;
      z-index: 1000;
    }
    .overlay.show {
      display: grid
    }
    .modal {
      background: linear-gradient(180deg, #162238, #0f182b);
      border: 1px solid rgba(255, 255, 255, .12);
      border-radius: 20px;
      padding: 22px;
      width: min(520px, 92vw);
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, .5);
      z-index: 1001;
    }
    .modal h2 {
      margin: 0 0 8px
    }
    .modal p {
      color: var(--muted);
      margin: 0 0 16px
    }

    .gate-controls {
      margin-top: 12px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <div class="title">Morse Dial Puzzle Box</div>
        <div class="subtitle">Rotate each strip so the Morse characters align to spell the hidden word.</div>
      </div>
      <div class="controls">
        <button id="btnShuffle">Shuffle</button>
        <button id="btnShare" title="Copy a link with this exact puzzle setup">Share Link</button>
      </div>
    </header>

    <div class="wrap">
      <div id="lock" class="lock" aria-live="polite"></div>
      <div class="divider"></div>
      <div class="gate locked" id="gate">
        <div class="status">LOCKED</div>
        <div class="word" id="currentWord"></div>
        <div class="gate-controls">
          <button id="btnUnlock">Unlock</button>
        </div>
        <div class="hint">Tip: use your mouse wheel or arrow buttons on each dial. Keyboard: Tab to focus a dial, then use ↑/↓.</div>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <h2 id="modalTitle">Box Status</h2>
      <p id="msg"></p>
      <button id="closeModal">Close</button>
    </div>
  </div>

  <div class="toast" id="toast">Link copied to clipboard</div>

  <script>
    (function() {
      const morseCode = {
        'A': '•–',
        'B': '–•••',
        'C': '–•–•',
        'D': '–••',
        'E': '•',
        'F': '••–•',
        'G': '––•',
        'H': '••••',
        'I': '••',
        'J': '•–––',
        'K': '–•–',
        'L': '•–••',
        'M': '––',
        'N': '–•',
        'O': '–––',
        'P': '•––•',
        'Q': '––•–',
        'R': '•–•',
        'S': '•••',
        'T': '–',
        'U': '••–',
        'V': '•••–',
        'W': '•––',
        'X': '–••–',
        'Y': '–•––',
        'Z': '––••'
      };
      const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';

      let secretWord = 'CODE';
      let victoryMessage = 'You unlocked the secret!';

      const lockEl = document.getElementById('lock');
      const gate = document.getElementById('gate');
      const wordEl = document.getElementById('currentWord');
      const overlay = document.getElementById('overlay');
      const msg = document.getElementById('msg');
      const modalTitle = document.getElementById('modalTitle');
      const toast = document.getElementById('toast');
      const unlockBtn = document.getElementById('btnUnlock');
      const closeModalBtn = document.getElementById('closeModal');

      const dials = [];
      let isSolved = false;

      function caesarShift(str, shift) {
        return str.split('').map(char => {
          const code = char.charCodeAt(0);
          if (code >= 65 && code <= 90) {
            return String.fromCharCode(((code - 65 + shift + 26) % 26) + 65);
          }
          return char;
        }).join('');
      }

      function getPuzzleFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const encodedWord = urlParams.get('word');
        const encodedMessage = urlParams.get('msg');

        if (encodedWord) {
          secretWord = caesarShift(decodeURIComponent(encodedWord), -5);
          if (encodedMessage) {
              victoryMessage = caesarShift(decodeURIComponent(encodedMessage), -5);
          } else {
              victoryMessage = 'You unlocked the secret!';
          }
        }
      }

      function createDials() {
        lockEl.innerHTML = '';
        dials.length = 0;
        for (let i = 0; i < secretWord.length; i++) {
          const dial = document.createElement('div');
          dial.className = 'dial';
          dial.setAttribute('data-index', i);
          dial.setAttribute('tabindex', '0');
          dial.setAttribute('role', 'button');
          dial.setAttribute('aria-label', `Dial for character ${i + 1}`);

          const head = document.createElement('div');
          head.className = 'head';
          const label = document.createElement('div');
          label.className = 'label';
          label.textContent = `Dial ${i + 1}`;
          const indexEl = document.createElement('div');
          indexEl.className = 'index';
          indexEl.textContent = 'A';
          head.appendChild(label);
          head.appendChild(indexEl);
          dial.appendChild(head);

          const windowEl = document.createElement('div');
          windowEl.className = 'window';
          const strip = document.createElement('div');
          strip.className = 'strip';

          const dialState = {
            root: dial,
            strip,
            index: 0,
            indexEl: indexEl
          };

          const cellHeight = 48;
          const windowHeight = 140;
          const offset = (windowHeight / 2) - (cellHeight / 2);

          function setIndex(newIndex) {
            const max = alphabet.length;
            dialState.index = (newIndex % max + max) % max;
            strip.style.transform = `translateY(${offset - dialState.index * cellHeight}px)`;
            dialState.indexEl.textContent = alphabet[dialState.index];

            [...strip.children].forEach((c, idx) => {
              c.classList.toggle('active', idx === dialState.index);
              c.querySelector('.letter').classList.toggle('revealed', idx === dialState.index);
            });
            updateDisplay();
          }

          for (let j = 0; j < 26; j++) {
            const charDiv = document.createElement('div');
            charDiv.classList.add('cell');
            charDiv.innerHTML = `<div class="morse">${morseCode[alphabet[j]]}</div><div class="letter">${alphabet[j]}</div>`;
            strip.appendChild(charDiv);
          }

          windowEl.appendChild(strip);
          dial.appendChild(windowEl);

          const upBtn = document.createElement('button');
          upBtn.className = 'arrow';
          upBtn.innerHTML = '▲';
          upBtn.onclick = () => setIndex(dialState.index - 1);

          const downBtn = document.createElement('button');
          downBtn.className = 'arrow';
          downBtn.innerHTML = '▼';
          downBtn.onclick = () => setIndex(dialState.index + 1);

          const ctrls = document.createElement('div');
          ctrls.className = 'controls';
          ctrls.appendChild(upBtn);
          ctrls.appendChild(downBtn);
          dial.appendChild(ctrls);

          dial.addEventListener('wheel', (e) => {
            e.preventDefault();
            setIndex(dialState.index + Math.sign(e.deltaY));
          });

          dial.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowUp') {
              e.preventDefault();
              setIndex(dialState.index - 1);
            } else if (e.key === 'ArrowDown') {
              e.preventDefault();
              setIndex(dialState.index + 1);
            }
          });

          dials.push({
            ...dialState,
            setIndex
          });
          lockEl.appendChild(dial);
        }
        shuffleDials();
      }

      function updateDisplay() {
        const currentMorse = dials.map(d => morseCode[alphabet[d.index]]).join(' ');
        wordEl.textContent = currentMorse || '•';
        checkSolution();
      }

      function checkSolution() {
        const currentWord = dials.map(d => alphabet[d.index]).join('');
        isSolved = currentWord.toUpperCase() === secretWord.toUpperCase();
        gate.classList.toggle('unlocked', isSolved);
        gate.classList.toggle('locked', !isSolved);
        gate.querySelector('.status').textContent = isSolved ? 'UNLOCKED' : 'LOCKED';
      }

      function shuffleDials() {
        dials.forEach(d => d.setIndex(Math.floor(Math.random() * alphabet.length)));
      }

      function showToast(message) {
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 1800);
      }

      function sharePuzzle() {
        const encodedWord = encodeURIComponent(caesarShift(secretWord, 5));
        const encodedMsg = encodeURIComponent(caesarShift(victoryMessage, 5));
        const url = `${window.location.protocol}//${window.location.host}${window.location.pathname}?word=${encodedWord}&msg=${encodedMsg}`;

        navigator.clipboard.writeText(url).then(() => {
          showToast('Shareable puzzle link copied!');
        }).catch(err => {
          console.error('Failed to copy link: ', err);
          showToast('Failed to copy link.');
        });
      }

      function unlock() {
        if (!isSolved) {
          modalTitle.textContent = "Incorrect Combination";
          msg.textContent = `The selected combination is not correct. Keep trying!`;
        } else {
          modalTitle.textContent = "Box Unlocked!";
          msg.innerHTML = victoryMessage + `<br><br>Word: ${secretWord}`;
        }
        overlay.classList.add('show');
      }

      document.getElementById('btnShuffle').addEventListener('click', shuffleDials);
      document.getElementById('btnShare').addEventListener('click', sharePuzzle);
      unlockBtn.addEventListener('click', unlock);
      closeModalBtn.addEventListener('click', () => {
        overlay.classList.remove('show');
      });

      getPuzzleFromUrl();
      createDials();
      console.log("Target word:", secretWord, "→ Morse:", secretWord.split('').map(L => morseCode[L]).join(' '));
    })();
  </script>

</body>
</html>
